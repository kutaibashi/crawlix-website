---
import BaseLayout from '../layouts/BaseLayout.astro';
import Header from '../components/layout/Header.astro';
import Footer from '../components/layout/Footer.astro';
import {
  Sparkles, Zap, Bug, AlertTriangle, Calendar, Tag, ArrowRight,
  Rss, Bell, ChevronRight, Download, Clock, Package, Star
} from '@lucide/astro';
import { getReleases } from '../lib/keystatic';
// Keep helper functions from TypeScript
import { formatDate, getChangeTypeColor, getChangeTypeLabel, getChangeTypeIcon } from '../data/changelog';

// Prerender this page
export const prerender = true;

// Fetch releases from Keystatic
const releases = await getReleases();

// Calculate stats
const changelogStats = {
  latestVersion: releases[0]?.version || '1.0.0',
  totalReleases: releases.length,
  totalFeatures: releases.reduce((acc, r) => acc + r.changes.filter(c => c.type === 'feature').length, 0),
  totalImprovements: releases.reduce((acc, r) => acc + r.changes.filter(c => c.type === 'improvement').length, 0),
};

// Icons for change types
const typeIcons = {
  feature: Sparkles,
  improvement: Zap,
  fix: Bug,
  breaking: AlertTriangle,
};
---

<BaseLayout
  title="Changelog - Crawlix SEO Crawler"
  description="Track all updates to Crawlix. New features, improvements, and bug fixes for the SEO crawler."
>
  <a href="#main-content" class="skip-link">Skip to main content</a>
  <Header slot="header" />

  <!-- Hero Section -->
  <section class="pt-32 pb-12 bg-gradient-to-b from-[#091a3d] to-[#0a1d42]">
    <div class="mx-auto max-w-5xl px-4 sm:px-6 lg:px-8">
      <div class="text-center animate-on-scroll">
        <div class="inline-flex items-center gap-2 rounded-full bg-emerald-500/10 border border-emerald-500/30 px-4 py-1.5 text-sm text-emerald-400 mb-6">
          <Package class="h-4 w-4" />
          <span>Version {changelogStats.latestVersion}</span>
        </div>

        <h1 class="text-4xl font-bold text-white sm:text-5xl">
          What's New in <span class="gradient-text-blue">Crawlix</span>
        </h1>

        <p class="mt-6 text-lg text-slate-400 max-w-2xl mx-auto">
          Track every update, new feature, and improvement. See how Crawlix evolves to help you audit websites better.
        </p>

        <!-- Stats Row -->
        <div class="mt-10 flex flex-wrap justify-center gap-8">
          <div class="text-center">
            <div class="text-3xl font-bold text-white">{changelogStats.totalReleases}</div>
            <div class="text-sm text-slate-500">Releases</div>
          </div>
          <div class="h-12 w-px bg-slate-800 hidden sm:block"></div>
          <div class="text-center">
            <div class="text-3xl font-bold text-emerald-400">{changelogStats.totalFeatures}</div>
            <div class="text-sm text-slate-500">New Features</div>
          </div>
          <div class="h-12 w-px bg-slate-800 hidden sm:block"></div>
          <div class="text-center">
            <div class="text-3xl font-bold text-sky-400">{changelogStats.totalImprovements}</div>
            <div class="text-sm text-slate-500">Improvements</div>
          </div>
        </div>

        <!-- Subscribe & RSS -->
        <div class="mt-10 flex flex-wrap justify-center gap-4">
          <a
            href="/blog"
            class="inline-flex items-center gap-2 rounded-lg bg-sky-600 px-5 py-2.5 text-sm font-medium text-white hover:bg-sky-500 transition-colors"
          >
            <Bell class="h-4 w-4" />
            Follow Updates
          </a>
          <a
            href="/changelog/rss.xml"
            class="inline-flex items-center gap-2 rounded-lg border border-slate-700 bg-slate-800/50 px-5 py-2.5 text-sm font-medium text-slate-300 hover:border-sky-500/50 hover:text-white transition-colors"
          >
            <Rss class="h-4 w-4" />
            RSS Feed
          </a>
        </div>
      </div>
    </div>
  </section>

  <!-- Version Navigation -->
  <section class="py-4 border-b border-slate-800/50 bg-[#0a1d42]/30 sticky top-16 z-40 backdrop-blur-sm">
    <div class="mx-auto max-w-5xl px-4 sm:px-6 lg:px-8">
      <div class="flex items-center gap-3 overflow-x-auto pb-2 scrollbar-hide">
        <span class="text-sm text-slate-500 shrink-0">Jump to:</span>
        {releases.map((release) => (
          <a
            href={`#v${release.version.replace(/\./g, '-')}`}
            class="shrink-0 rounded-full border border-slate-700 bg-slate-800/50 px-3 py-1.5 text-sm text-slate-400 hover:border-sky-500/50 hover:text-white transition-colors"
          >
            v{release.version}
          </a>
        ))}
      </div>
    </div>
  </section>

  <!-- Releases -->
  <section class="py-16" id="main-content">
    <div class="mx-auto max-w-5xl px-4 sm:px-6 lg:px-8">
      <div class="space-y-20">
        {releases.map((release, index) => {
          const isLatest = index === 0;

          return (
            <article
              id={`v${release.version.replace(/\./g, '-')}`}
              class="relative scroll-mt-32"
            >
              {/* Timeline connector */}
              {index < releases.length - 1 && (
                <div class="absolute left-6 top-16 bottom-0 w-px bg-gradient-to-b from-slate-700 to-transparent hidden lg:block" style="height: calc(100% + 5rem);"></div>
              )}

              <div class="lg:grid lg:grid-cols-12 lg:gap-8">
                {/* Left column - Version info */}
                <div class="lg:col-span-3 mb-6 lg:mb-0">
                  <div class="lg:sticky lg:top-32">
                    {/* Version badge */}
                    <div class="flex items-center gap-3 mb-4">
                      <div class={`flex h-12 w-12 items-center justify-center rounded-xl ${isLatest ? 'bg-emerald-500/20 text-emerald-400 border border-emerald-500/30' : 'bg-slate-800/50 text-slate-400 border border-slate-700'}`}>
                        <span class="text-lg font-bold">v{release.version.split('.')[0]}</span>
                      </div>
                      {isLatest && (
                        <span class="inline-flex items-center gap-1 rounded-full bg-emerald-500/20 border border-emerald-500/30 px-2 py-0.5 text-xs font-medium text-emerald-400">
                          <Star class="h-3 w-3" />
                          Latest
                        </span>
                      )}
                    </div>

                    {/* Version number */}
                    <h2 class="text-2xl font-bold text-white">
                      v{release.version}
                    </h2>

                    {/* Date */}
                    <div class="flex items-center gap-2 mt-2 text-sm text-slate-500">
                      <Calendar class="h-4 w-4" />
                      {formatDate(release.date)}
                    </div>

                    {/* Release type badge */}
                    <div class="mt-3">
                      <span class={`inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium ${
                        release.type === 'major'
                          ? 'bg-violet-500/20 text-violet-400'
                          : release.type === 'minor'
                          ? 'bg-sky-500/20 text-sky-400'
                          : 'bg-slate-500/20 text-slate-400'
                      }`}>
                        {release.type.charAt(0).toUpperCase() + release.type.slice(1)} Release
                      </span>
                    </div>

                    {/* Download link for latest */}
                    {isLatest && (
                      <a
                        href="/download"
                        class="mt-4 inline-flex items-center gap-2 text-sm text-sky-400 hover:text-sky-300 transition-colors"
                      >
                        <Download class="h-4 w-4" />
                        Download v{release.version}
                      </a>
                    )}
                  </div>
                </div>

                {/* Right column - Content */}
                <div class="lg:col-span-9">
                  {/* Release card */}
                  <div class={`rounded-2xl border ${isLatest ? 'border-emerald-500/30 bg-gradient-to-br from-emerald-500/5 to-transparent' : 'border-slate-800 bg-[#0e2655]/30'} p-6 lg:p-8`}>
                    {/* Title & Summary */}
                    <h3 class="text-xl font-semibold text-white mb-2">
                      {release.title}
                    </h3>
                    <p class="text-slate-400 mb-6">
                      {release.summary}
                    </p>

                    {/* Highlights */}
                    {release.highlights && release.highlights.length > 0 && (
                      <div class="mb-8 flex flex-wrap gap-2">
                        {release.highlights.map((highlight) => (
                          <span class="inline-flex items-center gap-1.5 rounded-lg bg-slate-800/50 border border-slate-700 px-3 py-1.5 text-sm text-slate-300">
                            <Sparkles class="h-3.5 w-3.5 text-emerald-400" />
                            {highlight}
                          </span>
                        ))}
                      </div>
                    )}

                    {/* Changes grouped by type */}
                    <div class="space-y-6">
                      {/* Features */}
                      {release.changes.filter(c => c.type === 'feature').length > 0 && (
                        <div>
                          <h4 class="flex items-center gap-2 text-sm font-semibold text-emerald-400 uppercase tracking-wider mb-4">
                            <Sparkles class="h-4 w-4" />
                            New Features
                          </h4>
                          <ul class="space-y-4">
                            {release.changes.filter(c => c.type === 'feature').map((change) => (
                              <li class="flex gap-3">
                                <span class="shrink-0 mt-1 h-1.5 w-1.5 rounded-full bg-emerald-400"></span>
                                <div>
                                  <div class="flex flex-wrap items-center gap-2">
                                    <span class="font-medium text-white">{change.title}</span>
                                    {change.badge && (
                                      <span class={`rounded-full px-2 py-0.5 text-[10px] font-medium ${
                                        change.badge === 'Pro'
                                          ? 'bg-violet-500/20 text-violet-400'
                                          : 'bg-amber-500/20 text-amber-400'
                                      }`}>
                                        {change.badge}
                                      </span>
                                    )}
                                  </div>
                                  {change.description && (
                                    <p class="mt-1 text-sm text-slate-400">{change.description}</p>
                                  )}
                                </div>
                              </li>
                            ))}
                          </ul>
                        </div>
                      )}

                      {/* Improvements */}
                      {release.changes.filter(c => c.type === 'improvement').length > 0 && (
                        <div>
                          <h4 class="flex items-center gap-2 text-sm font-semibold text-sky-400 uppercase tracking-wider mb-4">
                            <Zap class="h-4 w-4" />
                            Improvements
                          </h4>
                          <ul class="space-y-4">
                            {release.changes.filter(c => c.type === 'improvement').map((change) => (
                              <li class="flex gap-3">
                                <span class="shrink-0 mt-1 h-1.5 w-1.5 rounded-full bg-sky-400"></span>
                                <div>
                                  <span class="font-medium text-white">{change.title}</span>
                                  {change.description && (
                                    <p class="mt-1 text-sm text-slate-400">{change.description}</p>
                                  )}
                                </div>
                              </li>
                            ))}
                          </ul>
                        </div>
                      )}

                      {/* Bug Fixes */}
                      {release.changes.filter(c => c.type === 'fix').length > 0 && (
                        <div>
                          <h4 class="flex items-center gap-2 text-sm font-semibold text-amber-400 uppercase tracking-wider mb-4">
                            <Bug class="h-4 w-4" />
                            Bug Fixes
                          </h4>
                          <ul class="space-y-2">
                            {release.changes.filter(c => c.type === 'fix').map((change) => (
                              <li class="flex gap-3 text-sm text-slate-400">
                                <span class="shrink-0 mt-1.5 h-1.5 w-1.5 rounded-full bg-amber-400"></span>
                                <span>{change.title}</span>
                              </li>
                            ))}
                          </ul>
                        </div>
                      )}

                      {/* Breaking Changes */}
                      {release.changes.filter(c => c.type === 'breaking').length > 0 && (
                        <div class="rounded-lg border border-rose-500/30 bg-rose-500/10 p-4">
                          <h4 class="flex items-center gap-2 text-sm font-semibold text-rose-400 uppercase tracking-wider mb-3">
                            <AlertTriangle class="h-4 w-4" />
                            Breaking Changes
                          </h4>
                          <ul class="space-y-2">
                            {release.changes.filter(c => c.type === 'breaking').map((change) => (
                              <li class="flex gap-3 text-sm text-rose-200">
                                <span class="shrink-0 mt-1.5 h-1.5 w-1.5 rounded-full bg-rose-400"></span>
                                <div>
                                  <span class="font-medium">{change.title}</span>
                                  {change.description && (
                                    <p class="mt-1 text-rose-300/70">{change.description}</p>
                                  )}
                                </div>
                              </li>
                            ))}
                          </ul>
                        </div>
                      )}
                    </div>
                  </div>
                </div>
              </div>
            </article>
          );
        })}
      </div>
    </div>
  </section>

  <!-- CTA Section -->
  <section class="py-16 bg-gradient-to-b from-transparent to-[#0a1d42]/50">
    <div class="mx-auto max-w-4xl px-4 sm:px-6 lg:px-8">
      <div class="rounded-2xl border border-sky-500/30 bg-gradient-to-br from-sky-600/10 to-violet-600/10 p-8 md:p-12 text-center">
        <h2 class="text-2xl font-bold text-white">
          Ready to try the latest version?
        </h2>
        <p class="mt-4 text-slate-400">
          Download Crawlix v{changelogStats.latestVersion} and start auditing websites with 97+ SEO checks.
        </p>
        <div class="mt-8 flex flex-col sm:flex-row items-center justify-center gap-4">
          <a
            href="/download"
            class="inline-flex items-center gap-2 rounded-lg bg-sky-600 px-6 py-3 font-semibold text-white hover:bg-sky-500 transition-colors"
          >
            Download Free
            <Download class="h-4 w-4" />
          </a>
          <a
            href="/pricing"
            class="inline-flex items-center gap-2 text-slate-400 hover:text-white transition-colors"
          >
            View pricing
            <ArrowRight class="h-4 w-4" />
          </a>
        </div>
      </div>
    </div>
  </section>

  <Footer slot="footer" />
</BaseLayout>

<style>
  .gradient-text-blue {
    background: linear-gradient(135deg, #38bdf8 0%, #818cf8 50%, #38bdf8 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .scrollbar-hide {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }
  .scrollbar-hide::-webkit-scrollbar {
    display: none;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    // Initialize scroll animations
    const animationObserver = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          entry.target.classList.add('is-visible');
        }
      });
    }, { threshold: 0.1, rootMargin: '0px 0px -50px 0px' });

    document.querySelectorAll('.animate-on-scroll, .stagger-children, .scale-in').forEach(el => {
      animationObserver.observe(el);
    });

    // Smooth scroll for version links
    document.querySelectorAll('a[href^="#v"]').forEach(anchor => {
      anchor.addEventListener('click', (e) => {
        e.preventDefault();
        const targetId = anchor.getAttribute('href');
        if (targetId) {
          const target = document.querySelector(targetId);
          if (target) {
            target.scrollIntoView({ behavior: 'smooth', block: 'start' });
            // Update URL without triggering scroll
            history.pushState(null, '', targetId);
          }
        }
      });
    });

    // Highlight current version in nav on scroll
    const versionObserver = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            const id = entry.target.id;
            document.querySelectorAll('a[href^="#v"]').forEach((link) => {
              if (link.getAttribute('href') === `#${id}`) {
                link.classList.add('border-sky-500', 'text-white');
                link.classList.remove('border-slate-700', 'text-slate-400');
              } else {
                link.classList.remove('border-sky-500', 'text-white');
                link.classList.add('border-slate-700', 'text-slate-400');
              }
            });
          }
        });
      },
      { threshold: 0.3, rootMargin: '-100px 0px -50% 0px' }
    );

    document.querySelectorAll('article[id^="v"]').forEach((section) => {
      versionObserver.observe(section);
    });
  });
</script>
